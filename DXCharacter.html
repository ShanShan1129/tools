<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>DX3コマ作成🌳</title>
</head>

<body>
    <h1>🌳なるほどな🌳</h1>
    <p>
        いつものキャラシサイトの雑変換です　具体的に言えばキャラクター登録所
    </p>
    <form name="myform">
        <input name="URLinput" type="text" class="mybox" value="" placeholder="ここに駒にしたいキャラシのURLをコピペしてくれ(^^)" />
        <input name="btn" type="button" value="コマ作成・皇" onclick="makeDXCharacter()" />

    </form>
    <form name="resultform">
        <textarea name="myresult" class="mybox" placeholder="クリップボードへの自動転送うまくいかない場合はここにでたやつをコピペしてくれ(^^)"
            rows="3"></textarea>
    </form>
    <p>
        CSSの知識ないんでしょっぱい画面です　ゆるしてくれ
    </p>
</body>
<style>
    .mybox {
        display: inline-block;
        width: 100%;
        max-width: 330px;
    }
</style>

<script type="text/javascript">
    makeDXCharacter = function () {
        var charURLstr = document.forms.myform.URLinput.value;
        var charURL;
        try {
            charURL = new URL(charURLstr);
        } catch (error) {
            alert("🌈");
        }
        if (charURL.hostname !== "character-sheets.appspot.com" || !charURL.pathname.match(/\/dx3\/edit\.html$/) || !charURL.search || !navigator.clipboard) {
            alert("error OCN");
            return
        }
        var s = document.createElement("script");
        s.src = "https://" + charURL.hostname + "/dx3/display?ajax=1&callback=OCLDX3&key=" + (new URLSearchParams(charURL.search).get('key'));
        OCLDX3 = function (data) {
            var data2 = {
                "kind": "character",
                "data": {
                    "name": data.base.name || data.base.nameKana,
                    "externalUrl": charURL.href,
                    "initiative": Number(data.subAbility.action.total) || 0,
                    "status": [
                        {
                            "label": "HP",
                            "value": data.subAbility.hp.total,
                            "max": data.subAbility.hp.total
                        },
                        {
                            "label": "侵蝕率",
                            "value": data.subAbility.erotion.total,
                            "max": data.subAbility.erotion.total
                        },
                        {
                            "label": "ロイス",
                            "value": 3,
                            "max": 7
                        },
                        {
                            "label": "侵蝕率B",
                            "value": "",
                            "max": ""
                        },
                        {
                            "label": "財産P",
                            "value": data.subAbility.property.total,
                            "max": data.subAbility.property.total
                        }
                    ],
                    "params": [
                        {
                            "label": "肉体",
                            "value": data.baseAbility.body.total
                        },
                        {
                            "label": "感覚",
                            "value": data.baseAbility.sense.total
                        },
                        {
                            "label": "精神",
                            "value": data.baseAbility.mind.total
                        },
                        {
                            "label": "社会",
                            "value": data.baseAbility.society.total
                        }
                    ],
                    "active": true,
                    "secret": false,
                    "invisible": false,
                    "hideStatus": false,
                    "commands": "◆汎用チャットパレット\n//上昇\n{侵蝕率}+1d10　登場/リザレクト\n{侵蝕率}+nd10　ジェネシフト\n{侵蝕率}+2d10　衝動判定\n\n//判定用\n({肉体}+{侵蝕率B})dx　【肉体】\n({感覚}+{侵蝕率B})dx　【感覚】\n({精神}+{侵蝕率B})dx　【精神】\n({社会}+{侵蝕率B})dx　【社会】\n\n({感覚}+{侵蝕率B})dx　〈知覚〉\n({精神}+{侵蝕率B})dx　〈意志〉\n\n({肉体}+{侵蝕率B})dx　〈運転：〉\n({感覚}+{侵蝕率B})dx　〈芸術：〉\n({精神}+{侵蝕率B})dx　〈知識：〉\n({社会}+{侵蝕率B})dx　〈情報：〉\n\n//命中+コンボ\nコンボ『名称』タイミング/技能/射程/対象/侵蝕率n/効果\n({}+{侵蝕率B})dx8　99↓\n({}+{侵蝕率B})dx7　100↑\n\nd10+\nd10+\n\n//回避\n({肉体}+{侵蝕率B})dx　〈回避〉\n\n//バックトラック\n自己申告\n侵蝕率{侵蝕率}% ロイス{ロイス}個\n\n{侵蝕率}-{ロイス}d10　通常振り/追加振り\n{侵蝕率}-({ロイス}+{ロイス})d10　2倍振り"
                }
            };

            var Text = JSON.stringify(data2);
            document.forms.resultform.myresult.value = Text;
            navigator.clipboard.writeText(Text)
                .then(function () {
                    alert('クリップボードに出力・皇\nココフォリア盤面に張り付けてくれ(^^)');
                })
                .catch(err => {
                    alert('クリップボードに出力失敗🌈\n下のボックスの文字列をコピペしてココフォリア盤面に張り付けてくれ(^^)');
                });
        };
        document.body.appendChild(s);
    }
</script>

</html>