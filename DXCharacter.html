<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>DX3ã‚³ãƒä½œæˆğŸŒ³</title>
</head>

<body>
    <h1>ğŸŒ³ãªã‚‹ã»ã©ãªğŸŒ³</h1>
    <p>
        ã‚­ãƒ£ãƒ©ã‚·ã‚µã‚¤ãƒˆã®ã‚³ãƒç”Ÿæˆå™¨ã <br>é£²ã‚“ã§ãã‚Œï¼<br>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç™»éŒ²æ‰€ã¨ã‹ã‚†ã¨ã‚·ã¨ã‹ã«å¯¾å¿œã—ã¦ã‚‹ã®ã‚’ï½µï½¯ï½¼ï½ªï¾™
    </p>
    <form name="myform">
        <input name="URLinput" type="text" class="myinputbox" value="" placeholder="ã“ã“ã«é§’ã«ã—ãŸã„ã‚­ãƒ£ãƒ©ã‚·ã®URLã‚’ã‚³ãƒ”ãƒšã—ã¦ãã‚Œ(^^)" />
        <input name="btn" type="button" value="ã‚³ãƒä½œæˆãƒ»çš‡" onclick="makeDXCharacter()" />
        <label><input type="checkbox" id="YutoLimiter">è‡ªé¯–ã®ã‚†ã¨ã‚·ã‚’ä½¿ã†</label>
        <label><input type="checkbox" id="corsLimiter">ç„¡æ³•</label>
    </form>
    <form name="resultform">
        <textarea name="myresult" class="myoutputbox" placeholder="ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®è‡ªå‹•è»¢é€ã†ã¾ãã„ã‹ãªã„å ´åˆã¯ã“ã“ã«ã§ãŸã‚„ã¤ã‚’ã‚³ãƒ”ãƒšã—ã¦ãã‚Œ(^^)" cols="26"
            rows="3"></textarea>
    </form>
    <p>
        ä¾‹å¤–ã¯ã‚ã‚‹ã‘ã©ãƒ­ã‚¤ã‚¹ã¯åˆæœŸå€¤ãŒ3ã®å›ºå®šå€¤ã§ã™ã€€æ°—ã‚’ä»˜ã‘ã¦ãã‚Œ<br>ã¾ãŸã€ã‚†ã¨ã‚·ãƒ¼ãƒˆã§ãƒ‡ãƒ•ã‚©ã®ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒ¬ãƒƒãƒˆã‚’ä½¿ã£ã¦ã‚‹å ´åˆã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚‚å«ã‚ã¦è‡ªåˆ†ã§å¼•ã£å¼µã£ã¦æ¥ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ã‚’æ•™ãˆã‚‹<br>ã§ã‚‚ã‚ã‚“ã©ã‹ã£ãŸã‚‰ç„¡æ³•ã«ãƒã‚§ãƒƒã‚¯å…¥ã‚Œã‚‹ã¨å¼•ã£å¼µã‚Œã‚‹ã“ã¨ã‚‚æ•™ãˆã‚‹ã€€ç„¡æ³•ã ã‘ã©
    </p>
    <p>
        CSSã®çŸ¥è­˜ãªã„ã‚“ã§ã—ã‚‡ã£ã±ã„ç”»é¢ã§ã™<br>ã‚¹ãƒãƒ›å¯¾å¿œã‚‚ã§ããªã„æ•—åŒ—è€…ï½ğŸŒˆ
    </p>
    <p>
        çµå±€javascriptã§ã„ã‚ã‚“ãªã¨ã“ã®JSONã®APIå©ã„ã¦ã‚‹ã ã‘ãªã®ã‚’æ•™ãˆã‚‹
    </p>
    <h3>ğŸŒ³å¤‰æ›´å±¥æ­´ğŸŒ³</h3>
    <p>
        ver1.3<br>
        ã‚†ã¨ã‚·ã§è‡ªä½œãƒãƒ£ãƒ‘ãƒ¬ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã‹ã¤ãƒãƒ£ãƒ‘ãƒ¬ã«èƒ½åŠ›å€¤å¤‰æ•°ãŒãªã„å ´åˆãƒ—ãƒªã‚»ãƒƒãƒˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«<br>
        ã¤ã„ã§ã«ç„¡æ³•ç„¡ã—ã§ã‚‚ãƒ—ãƒªã‚»ãƒƒãƒˆãŒå‡ºã¦ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ<br>
        ver1.2<br>
        ã‚†ã¨ã‚·ã«å¯¾å¿œé–‹å§‹
    </p>
</body>
<style>
    .myinputbox {
        display: inline-block;
        width: 100%;
        font-size: large;
        max-width: 512px;
    }

    .myoutputbox {
        display: inline-block;
        width: 100%;
        max-width: 640px;
    }

    p {
        display: inline-block;
        width: 100%;
    }
</style>

<script type="text/javascript">
    makeDXCharacter = async function () {
        var charURLstr = document.forms.myform.URLinput.value;
        var charURL;
        try {
            charURL = new URL(charURLstr);
        } catch (error) {
            alert("ğŸŒˆ");
        }
        if (!charURL.search || !navigator.clipboard) {
            alert("error OCN");
            return
        }
        if (checkCharacterSheets(charURL)) {
            var s = document.createElement("script");
            s.src = "https://" + charURL.hostname + "/dx3/display?ajax=1&callback=OCLDX3&key=" + (new URLSearchParams(charURL.search).get('key'));
            OCLDX3 = (data) => {
                var data2 = {
                    "kind": "character",
                    "data": {
                        "name": data.base.name || data.base.nameKana,
                        "externalUrl": charURL.href,
                        "initiative": Number(data.subAbility.action.total) || 0,
                        "status": [
                            {
                                "label": "HP",
                                "value": data.subAbility.hp.total,
                                "max": data.subAbility.hp.total
                            },
                            {
                                "label": "ä¾µè•ç‡",
                                "value": data.subAbility.erotion.total,
                                "max": data.subAbility.erotion.total
                            },
                            {
                                "label": "ãƒ­ã‚¤ã‚¹",
                                "value": 3,
                                "max": 7
                            },
                            {
                                "label": "ä¾µè•ç‡B",
                                "value": "",
                                "max": ""
                            },
                            {
                                "label": "è²¡ç”£P",
                                "value": data.subAbility.property.total,
                                "max": data.subAbility.property.total
                            }
                        ],
                        "params": [
                            {
                                "label": "è‚‰ä½“",
                                "value": data.baseAbility.body.total
                            },
                            {
                                "label": "æ„Ÿè¦š",
                                "value": data.baseAbility.sense.total
                            },
                            {
                                "label": "ç²¾ç¥",
                                "value": data.baseAbility.mind.total
                            },
                            {
                                "label": "ç¤¾ä¼š",
                                "value": data.baseAbility.society.total
                            }
                        ],
                        "active": true,
                        "secret": false,
                        "invisible": false,
                        "hideStatus": false,
                        "commands": "â—†æ±ç”¨ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒ¬ãƒƒãƒˆ\n//ä¸Šæ˜‡\n{ä¾µè•ç‡}+1d10ã€€ç™»å ´/ãƒªã‚¶ãƒ¬ã‚¯ãƒˆ\n{ä¾µè•ç‡}+nd10ã€€ã‚¸ã‚§ãƒã‚·ãƒ•ãƒˆ\n{ä¾µè•ç‡}+2d10ã€€è¡å‹•åˆ¤å®š\n\n//åˆ¤å®šç”¨\n({è‚‰ä½“}+{ä¾µè•ç‡B})dxã€€ã€è‚‰ä½“ã€‘\n({æ„Ÿè¦š}+{ä¾µè•ç‡B})dxã€€ã€æ„Ÿè¦šã€‘\n({ç²¾ç¥}+{ä¾µè•ç‡B})dxã€€ã€ç²¾ç¥ã€‘\n({ç¤¾ä¼š}+{ä¾µè•ç‡B})dxã€€ã€ç¤¾ä¼šã€‘\n\n({æ„Ÿè¦š}+{ä¾µè•ç‡B})dxã€€ã€ˆçŸ¥è¦šã€‰\n({ç²¾ç¥}+{ä¾µè•ç‡B})dxã€€ã€ˆæ„å¿—ã€‰\n\n({è‚‰ä½“}+{ä¾µè•ç‡B})dxã€€ã€ˆé‹è»¢ï¼šã€‰\n({æ„Ÿè¦š}+{ä¾µè•ç‡B})dxã€€ã€ˆèŠ¸è¡“ï¼šã€‰\n({ç²¾ç¥}+{ä¾µè•ç‡B})dxã€€ã€ˆçŸ¥è­˜ï¼šã€‰\n({ç¤¾ä¼š}+{ä¾µè•ç‡B})dxã€€ã€ˆæƒ…å ±ï¼šã€‰\n\n//å‘½ä¸­+ã‚³ãƒ³ãƒœ\nã‚³ãƒ³ãƒœã€åç§°ã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°/æŠ€èƒ½/å°„ç¨‹/å¯¾è±¡/ä¾µè•ç‡n/åŠ¹æœ\n({}+{ä¾µè•ç‡B})dx8ã€€99â†“\n({}+{ä¾µè•ç‡B})dx7ã€€100â†‘\n\nd10+\nd10+\n\n//å›é¿\n({è‚‰ä½“}+{ä¾µè•ç‡B})dxã€€ã€ˆå›é¿ã€‰\n\n//ãƒãƒƒã‚¯ãƒˆãƒ©ãƒƒã‚¯\nè‡ªå·±ç”³å‘Š\nä¾µè•ç‡{ä¾µè•ç‡}% ãƒ­ã‚¤ã‚¹{ãƒ­ã‚¤ã‚¹}å€‹\n\n{ä¾µè•ç‡}-{ãƒ­ã‚¤ã‚¹}d10ã€€é€šå¸¸æŒ¯ã‚Š/è¿½åŠ æŒ¯ã‚Š\n{ä¾µè•ç‡}-({ãƒ­ã‚¤ã‚¹}+{ãƒ­ã‚¤ã‚¹})d10ã€€2å€æŒ¯ã‚Š"
                    }
                };

                var Text = JSON.stringify(data2);
                document.forms.resultform.myresult.value = Text;
                navigator.clipboard.writeText(Text)
                    .then(function () {
                        alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«å‡ºåŠ›ãƒ»çš‡\nã‚³ã‚³ãƒ•ã‚©ãƒªã‚¢ç›¤é¢ã«å¼µã‚Šä»˜ã‘ã¦ãã‚Œ(^^)');
                    })
                    .catch(err => {
                        alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«å‡ºåŠ›å¤±æ•—ğŸŒˆ\nä¸‹ã®ãƒœãƒƒã‚¯ã‚¹ã®æ–‡å­—åˆ—ã‚’ã‚³ãƒ”ãƒšã—ã¦ã‚³ã‚³ãƒ•ã‚©ãƒªã‚¢ç›¤é¢ã«å¼µã‚Šä»˜ã‘ã¦ãã‚Œ(^^)');
                    });
            };
            document.body.appendChild(s);
        }
        else if (checkYutorize(charURL)) {
            var s = document.createElement("script");
            s.src = charURL + '&mode=json&callback=OCLYutoDX3';
            OCLYutoDX3 = async (data) => {
                let palette;
                if (data.chatPalette) {
                    palette = separateYutorizeChatPalette(data.chatPalette);
                }
                else if (document.getElementById('corsLimiter').checked) {
                    document.forms.resultform.myresult.value = 'ç„¡æ³•ä¸­â€¦ã¡ã‚‡ã£ã¨æ™‚é–“ãŒï½¶ï½¶ï¾™ï¾–ï½¯';
                    palette = await getYutorizeChatPalette(charURL);
                }
                else {
                    palette = {};
                }
                var data2 = {
                    "kind": "character",
                    "data": {
                        "name": data.characterName || data.aka,
                        "externalUrl": charURL.href,
                        "memo": `${data.characterNameRuby ? '(' + data.characterNameRuby + ')\n' : ''}PL: ${data.playerName || 'PLæƒ…å ±ç„¡ã—'}\n${data.works || ''} / ${data.cover || ''}\n${data.syndrome1 || ''}${data.syndrome2 ? 'ã€' + data.syndrome2 : ''}${data.syndrome3 ? 'ã€' + data.syndrome3 : ''}\n\n${data.imageURL ? 'ç«‹ã¡çµµï¼š' + (data.imageCopyright || 'æ¨©åˆ©æƒ…å ±ãªã—') : ''}`,
                        "initiative": Number(data.initiativeTotal || 0),
                        "status": [
                            {
                                "label": 'HP',
                                "value": data.maxHpTotal,
                                "max": data.maxHpTotal
                            }, {
                                "label": 'ä¾µè•ç‡',
                                "value": data.baseEncroach || 0,
                                "max": 300
                            }, {
                                "label": 'ãƒ­ã‚¤ã‚¹',
                                "value": data.loisHave !== undefined ? data.loisHave : 3,
                                "max": data.loisMax || 7
                            }, {
                                "label": 'è²¡ç”£ç‚¹',
                                "value": data.savingTotal,
                                "max": data.savingTotal
                            }
                        ],
                        "params": (JSON.stringify(palette.parameters) !== JSON.stringify([]) && palette.parameters!==undefined)? palette.parameters :
                            [
                                {
                                    "label": "è‚‰ä½“",
                                    "value": data.sttTotalBody
                                }, {
                                    "label": "æ„Ÿè¦š",
                                    "value": data.sttTotalSense
                                }, {
                                    "label": "ç²¾ç¥",
                                    "value": data.sttTotalMind
                                }, {
                                    "label": "ç¤¾ä¼š",
                                    "value": data.sttTotalSocial
                                }, {
                                    "label": "ç™½å…µ",
                                    "value": data.skillTotalMelee
                                }, {
                                    "label": "å›é¿",
                                    "value": data.skillTotalDodge
                                }, {
                                    "label": "å°„æ’ƒ",
                                    "value": data.skillTotalRanged
                                }, {
                                    "label": "çŸ¥è¦š",
                                    "value": data.skillTotalPercept
                                }, {
                                    "label": "RC",
                                    "value": data.skillTotalRC
                                }, {
                                    "label": "æ„å¿—",
                                    "value": data.skillTotalWill
                                }, {
                                    "label": "äº¤æ¸‰",
                                    "value": data.skillTotalNegotiate
                                }, {
                                    "label": "èª¿é”",
                                    "value": data.skillTotalProcure
                                }
                            ] || [],
                        "active": true,
                        "secret": false,
                        "invisible": false,
                        "hideStatus": false,
                        "commands": palette.palette || '',
                    }
                };

                var Text = JSON.stringify(data2);
                document.forms.resultform.myresult.value = Text;
                navigator.clipboard.writeText(Text)
                    .then(function () {
                        alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«å‡ºåŠ›ãƒ»çš‡\nã‚³ã‚³ãƒ•ã‚©ãƒªã‚¢ç›¤é¢ã«å¼µã‚Šä»˜ã‘ã¦ãã‚Œ(^^)');
                    })
                    .catch(err => {
                        alert('ä¸‹ã®ãƒœãƒƒã‚¯ã‚¹ã®æ–‡å­—åˆ—ã‚’ã‚³ãƒ”ãƒšã—ã¦ã‚³ã‚³ãƒ•ã‚©ãƒªã‚¢ç›¤é¢ã«å¼µã‚Šä»˜ã‘ã¦ãã‚Œ(^^)');
                    });
            };
            document.body.appendChild(s);

        }
        else {
            alert("ãªã‚“ã ï¼ï¼Ÿ(^^)ãªã‚“ã ï¼ï¼Ÿ(^^)\nã©ã“ã®URLãªã‚“ã ï¼Ÿ");
        }
    };

    function checkCharacterSheets(url) {
        return (url.hostname === "character-sheets.appspot.com" && url.pathname.match(/\/dx3\/edit\.html$/));
    }
    function checkYutorize(url) {
        return ((url.hostname === "yutorize.2-d.jp" || document.getElementById('YutoLimiter').checked) && url.pathname.match(/\/dx3rd\//));
    }
    /*
    function getYutorizeJsonData(url) {
        return new Promise((resolve, reject) => {
            let xhr = new XMLHttpRequest();
            xhr.open('GET', 'https://api.codetabs.com/v1/proxy/?quest=' + url + '&mode=json', true);
            xhr.responseType = "json";
            xhr.onload = (e) => {
                resolve(e.currentTarget.response);
            };
            xhr.onerror = () => reject('error');
            xhr.onabort = () => reject('abort');
            xhr.ontimeout = () => reject('timeout');
            xhr.send();
        });
    }
    */
    function getYutorizeChatPalette(url) {
        return new Promise((resolve, reject) => {
            let xhr = new XMLHttpRequest();
            xhr.open('GET', 'https://api.codetabs.com/v1/proxy/?quest=' + url + '&propertiesall=1&tool=bcdice&mode=palette', true);
            xhr.responseType = "text";
            xhr.onload = (e) => {
                resolve(separateYutorizeChatPalette(e.currentTarget.response));
            };
            xhr.onerror = () => resolve('');
            xhr.onabort = () => resolve('');
            xhr.ontimeout = () => resolve('');
            xhr.send();
        });
    }

    function separateYutorizeChatPalette(str) {
        const result = {
            palette: '',
            parameters: []
        };
        const palette = [];
        const parameterRegExp = /^\/\/(.+)[=\uFF1D]([0-9\+\-\/\*]+)?$/;
        //console.log(str);
        str = str.replace(/&lt;br&gt;/g, '\n');
        //console.log(str);
        str.split('\n').forEach((line) => {
            const parameterExecResult = parameterRegExp.exec(line);
            if (parameterExecResult) {
                result.parameters.push({
                    label: parameterExecResult[1],
                    value: (parameterExecResult[2] !== undefined ? parameterExecResult[2] : '')
                });
            } else {
                palette.push(line);
            }
        });
        result.palette = palette.join('\n');
        //console.log(result.parameters);
        //console.log(Boolean(result.parameters));
        //console.log(result.parameters !== []);
        return result;
    }
</script>

</html>